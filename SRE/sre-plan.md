### **План размещения отказоустойчивого .NET приложения в Yandex Cloud**

**Цель:** Развернуть stateless .NET приложение с публичным HTTPS-доступом, обеспечив отказоустойчивость в рамках одной зоны доступности.

**Архитектура:**

1.  **Уровень доступа:** Публичный Load Balancer (Yandex Application Load Balancer).
2.  **Уровень представления:** Nginx в качестве reverse proxy/webserver, работающий в контейнере.
3.  **Уровень приложения:** .NET приложение, работающее в контейнере.
4.  **Уровень данных:** Отказоустойчивый кластер Managed PostgreSQL (2+ хоста).
5.  **Вычислительная платформа:** Группа виртуальных машин (Instance Group) с автоматическим масштабированием.

**Детализированный план:**

#### **1. Yandex Application Load Balancer (L7)**
*   **Тип:** Публичный, с обработкой HTTPS.
*   **Конфигурация:**
    *   **Целевая группа:** Будет привязана к группе виртуальных машин (см. ниже).
    *   **HTTP-роутер:** Создается правило для маршрутизации всего трафика (например, `/*`) на целевую группу.
    *   **Виртуальный хост:** Указывается ваше доменное имя (например, `app.example.com`).
    *   **HTTPS:** Активируется с привязкой сертификата из **Yandex Certificate Manager**. Load Balancer будет терминировать SSL-соединение.
    *   **Проверка состояния (Health Check):** Настроена на эндпоинт .NET приложения (например, `/health` или `/`) для отслеживания работоспособности каждого инстанса.

#### **2. Группа виртуальных машин (Instance Group)**
*   **Цель:** Обеспечить отказоустойчивость и возможность автомасштабирования.
*   **Конфигурация:**
    *   **Размещение:** Одна зона доступности (например, `ru-central1-a`), но на разных физических хостах (anti-affinity policy) для устойчивости к сбоям на уровне гипервизора.
    *   **Шаблон ВМ:**
        *   **Платформа:** Intel Cascade Lake (`standard-v3`), конфигурация: **4 vCPU, 8 ГБ RAM** (как указано).
        *   **Диск:** Загрузочный диск SSD от 20 ГБ.
        *   **Сервисный аккаунт:** С правами на pull образов из Container Registry.
        *   **Метаданные:** Ключ `user-data` для запуска контейнеров через Docker Compose или систему инициализации (например, cloud-init).
    *   **Масштабирование:** На старте — фиксированное количество 2 ВМ. Далее можно настроить автомасштабирование на основе CPU (например, масштабировать от 2 до 6 инстансов при нагрузке >70%).
    *   **Правило распределения трафика:** Создается целевая группа для этой instance group, которую слушает Load Balancer.

#### **3. Контейнеризация (на каждой ВМ из группы)**
На каждой виртуальной машине будут запущены два контейнера через Docker Compose:

```yaml
version: '3.8'
services:
  nginx:
    image: your-registry/nginx:latest # Образ с вашей конфигурацией
    ports:
      - "80:80" # ALB будет обращаться на 80 порт ВМ
    depends_on:
      - dotnet-app
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

  dotnet-app:
    image: your-registry/dotnet-app:latest
    expose:
      - "5000" # Expose port internally for nginx
    environment:
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__Postgres=... # Строка подключения к Managed PG
    restart: unless-stopped
```
*
